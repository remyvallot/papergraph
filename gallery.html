<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Gallery - Papergraph</title>
    
    <link href="https://api.fontshare.com/v2/css?f[]=chillax@400,700&display=swap" rel="stylesheet">
    
    <!-- Modular CSS - Base -->
    <link rel="stylesheet" href="css/base/reset.css">
    <link rel="stylesheet" href="css/base/typography.css">
    
    <!-- Modular CSS - Components -->
    <link rel="stylesheet" href="css/components/buttons.css">
    <link rel="stylesheet" href="css/components/dropdown.css">
    <link rel="stylesheet" href="css/components/modals.css">
    <link rel="stylesheet" href="css/components/footer.css">
    <link rel="stylesheet" href="css/components/onboarding.css">
    
    <!-- Cursors - MUST BE LAST to override everything -->
    <link rel="stylesheet" href="css/base/cursors.css">
    
    <link rel="icon" type="image/svg+xml" href="assets/logo-papergraph.svg">
</head>
<body>
    <!-- Page Container -->
    <div class="pg-page">
        
        <!-- Header -->
        <header class="pg-header">
            <!-- Logo Menu -->
            <div class="logo-menu-container">
                <button class="logo-menu-btn">
                    <img src="assets/logo-papergraph.svg" alt="papergraph" class="logo-icon">
                    <span class="logo-text">papergraph</span>
                </button>
                
                <!-- Logo Dropdown -->
                <div id="logoDropdown" class="logo-dropdown">
                    <!-- File Section -->
                    <div class="logo-dropdown-section-title">File</div>
                    <button class="logo-dropdown-item" id="dashboardBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                        <span>Dashboard</span>
                    </button>
                    <button class="logo-dropdown-item logo-dropdown-item-auth-required" id="newProjectBtn" onclick="createNewProject()" style="display: none;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span>New Project</span>
                    </button>
                    <div class="logo-dropdown-divider"></div>
                    
                    <div class="logo-dropdown-section-title">Gallery</div>
                    <button class="logo-dropdown-item" onclick="window.location.href='gallery.html'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        <span>Explore Gallery</span>
                    </button>
                    <button class="logo-dropdown-item" id="submitBtn" onclick="handleSubmitClick()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <span>Submit to Gallery</span>
                    </button>
                    <div class="logo-dropdown-divider"></div>
                    <div class="logo-dropdown-section-title">Help</div>
                    <button class="logo-dropdown-item" onclick="window.open('https://github.com/remyvallot/papergraph#readme', '_blank')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 1 1 5.82 1c0 2-3 2.5-3 4"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>Help</span>
                    </button>
                    <button class="logo-dropdown-item" onclick="window.open('https://github.com/remyvallot/papergraph/issues/new', '_blank')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <g transform="translate(0,-2)">
                                <rect x="7" y="9" width="10" height="10" rx="5" ry="5"/>
                                <line x1="7" y1="12" x2="3" y2="10"/>
                                <line x1="7" y1="15" x2="3" y2="15"/>
                                <line x1="7" y1="18" x2="3" y2="20"/>
                                <line x1="17" y1="12" x2="21" y2="10"/>
                                <line x1="17" y1="15" x2="21" y2="15"/>
                                <line x1="17" y1="18" x2="21" y2="20"/>
                            </g>
                        </svg>
                        <span>Report Bug</span>
                    </button>
                </div>
            </div>
            
            <div class="pg-header-actions">
                <!-- User Avatar Dropdown -->
                <div class="user-dropdown-container">
                    <button id="userAvatarBtn" class="user-avatar-btn" style="display: none;">
                        <img id="userAvatar" class="pg-avatar" src="" alt="User">
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="userDropdown" class="user-dropdown">
                        <div class="user-dropdown-header">
                            <img id="userAvatarDropdown" class="user-dropdown-avatar" src="" alt="User">
                            <div class="user-dropdown-info">
                                <div id="userNameDropdown" class="user-dropdown-name"></div>
                                <div id="userUsernameDropdown" class="user-dropdown-username"></div>
                            </div>
                        </div>
                        <div class="user-dropdown-divider"></div>
                        <button class="user-dropdown-item" onclick="openPreferencesModal()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/>
                            </svg>
                            Preferences
                        </button>
                        <div class="user-dropdown-divider"></div>
                        <button class="user-dropdown-item user-dropdown-item-danger" onclick="signOut()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            Sign Out
                        </button>
                    </div>
                </div>
                
                <!-- Sign In Button (shown when not logged in) -->
                <button id="signInBtn" class="btn-secondary" onclick="openAuthModal()" style="display: none;">
                    Sign In
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pg-main">
            <div class="pg-dashboard-header">
                <h1>Explore Gallery</h1>
                <div class="pg-header-buttons">
                    <button id="submitToGalleryBtn" class="btn-primary" onclick="openSubmitToGalleryModal()" style="display: none;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Submit to Gallery
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" style="text-align: center; padding: 80px 32px; color: #999;">
                <p>Loading gallery projects...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="pg-empty-state" style="display: none;">
                <h2>No projects in the gallery yet</h2>
                <p>Be the first to share your research with the community!</p>
                <button class="btn-primary" onclick="openSubmitToGalleryModal()">Submit a Project</button>
            </div>

            <!-- Gallery Grid -->
            <div id="galleryGrid" class="pg-projects-grid" style="display: none;">
                <!-- Project cards will be loaded here -->
            </div>
        </main>

        <!-- Footer -->
        <div data-include="footer"></div>

    </div>

    <!-- Preferences Modal -->
    <div data-include="preferences-modal"></div>

    <!-- Submit to Gallery Modal -->
    <div id="submitGalleryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSubmitGalleryModal()">&times;</span>
            <h2>Submit to Gallery</h2>
            <form id="submitGalleryForm" onsubmit="handleSubmitToGallery(event)">
                <div class="form-group">
                    <label for="submitProjectSelect">Select Project</label>
                    <select id="submitProjectSelect" class="form-input" required>
                        <option value="">Choose a project...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="submitTitle">Title</label>
                    <input type="text" id="submitTitle" class="form-input" placeholder="Project title" maxlength="100" required>
                </div>

                <div class="form-group">
                    <label for="submitDescription">Description (2 lines max)</label>
                    <textarea id="submitDescription" class="form-input" placeholder="Brief description of your research project..." rows="3" maxlength="200" required></textarea>
                    <small style="color: #999;"><span id="descCharCount">0</span>/200 characters</small>
                </div>

                <div class="form-group">
                    <label for="submitAuthor">Full Name</label>
                    <input type="text" id="submitAuthor" class="form-input" placeholder="Your full name" required>
                </div>

                <div class="form-group">
                    <label for="submitAffiliation">Affiliation</label>
                    <input type="text" id="submitAffiliation" class="form-input" placeholder="University or institution" required>
                </div>

                <div class="form-group">
                    <label>Thumbnail (optional)</label>
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center;">
                        <div id="thumbnailPreview" style="display: none; position: relative;">
                            <img id="thumbnailImg" src="" alt="Thumbnail" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                            <button type="button" onclick="removeThumbnail()" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
                        </div>
                        <div id="thumbnailPlaceholder">
                            <p style="margin: 0 0 10px;">Click to upload an image</p>
                            <button type="button" class="btn-secondary" onclick="document.getElementById('thumbnailInput').click()">Choose File</button>
                        </div>
                        <input type="file" id="thumbnailInput" accept="image/png,image/jpeg" style="display: none;">
                    </div>
                </div>

                <p style="background: #f5f9ff; border-left: 4px solid #4a90e2; padding: 12px; margin: 20px 0; font-size: 0.9rem;">
                    <strong>Note:</strong> GitHub authentication is required. Submissions create a merge request for review.
                </p>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeSubmitGalleryModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="submitGalleryButton">Submit Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <button class="auth-modal-close" onclick="closeAuthModal()">&times;</button>
            
            <div class="auth-modal-header">
                <h2 id="authModalTitle">Welcome to Papergraph</h2>
                <p id="authModalSubtitle">Sign in to access the gallery features</p>
            </div>

            <!-- Error/Success Messages -->
            <div id="authMessage"></div>

            <!-- OAuth Providers -->
            <div class="auth-providers">
                <button class="auth-provider-btn" onclick="signInWithGitHub()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    Continue with GitHub
                </button>
                
                <button class="auth-provider-btn" onclick="signInWithGoogle()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Continue with Google
                </button>
            </div>

            <div class="auth-divider">
                <span>or continue with email</span>
            </div>

            <!-- Email Form -->
            <form id="authForm" class="auth-form" onsubmit="handleAuthSubmit(event)">
                <input 
                    type="text" 
                    id="authFullName" 
                    placeholder="Full Name"
                    style="display: none;"
                />
                <input 
                    type="text" 
                    id="authUsername" 
                    placeholder="Username"
                    minlength="3"
                    maxlength="20"
                    pattern="[a-zA-Z0-9_]+"
                    title="Username must be 3-20 characters (letters, numbers, underscore only)"
                    style="display: none;"
                />
                <input 
                    type="email" 
                    id="authEmail" 
                    placeholder="Email address" 
                    required
                />
                <input 
                    type="password" 
                    id="authPassword" 
                    placeholder="Password" 
                    required
                    minlength="6"
                />
                <button type="submit" class="btn-primary" id="authSubmitBtn">
                    Sign in
                </button>
            </form>

            <div class="auth-form-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <button type="button" onclick="toggleAuthMode()">Sign up</button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Gallery Logic -->
    <script type="module">
        import { supabase } from './js/auth/config.js';
        import { loadGalleryProjects, openGalleryProject } from './js/data/gallery.js';
        
        let currentUser = null;
        let isSignUp = false;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üé® Gallery page loading...');
            
            // Check if user is logged in
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    currentUser = session.user;
                    setupUserDropdown();
                    document.getElementById('submitToGalleryBtn').style.display = 'flex';
                    document.getElementById('signInBtn').style.display = 'none';
                    console.log('‚úÖ User logged in:', currentUser.email);
                } else {
                    document.getElementById('signInBtn').style.display = 'block';
                    document.getElementById('submitToGalleryBtn').style.display = 'none';
                    console.log('‚ÑπÔ∏è No user logged in');
                }
            } catch (error) {
                console.error('‚ùå Auth check error:', error);
                document.getElementById('signInBtn').style.display = 'block';
            }

            // Setup logo dropdown AFTER checking auth
            setupLogoDropdown();

            // Load gallery projects
            await loadGalleryProjects();
        });

        function setupUserDropdown() {
            if (!currentUser) return;
            
            const userAvatarBtn = document.getElementById('userAvatarBtn');
            const userAvatar = document.getElementById('userAvatar');
            const userDropdown = document.getElementById('userDropdown');
            
            const avatarUrl = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
            const username = currentUser.user_metadata?.username;
            const displayName = currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || currentUser.email.split('@')[0];
            
            if (avatarUrl) {
                userAvatar.src = avatarUrl;
                document.getElementById('userAvatarDropdown').src = avatarUrl;
            }
            
            document.getElementById('userNameDropdown').textContent = displayName;
            
            const usernameElement = document.getElementById('userUsernameDropdown');
            if (username) {
                usernameElement.textContent = `@${username}`;
                usernameElement.style.display = 'block';
            } else {
                usernameElement.style.display = 'none';
            }
            
            userAvatarBtn.style.display = 'flex';
            
            userAvatarBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                if (!userAvatarBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
        }

        function setupLogoDropdown() {
            const logoMenuBtn = document.querySelector('.logo-menu-btn');
            const logoDropdown = document.getElementById('logoDropdown');
            
            if (!logoMenuBtn || !logoDropdown) return;
            
            // Show/hide Dashboard and New Project based on authentication
            const dashboardBtn = document.getElementById('dashboardBtn');
            const newProjectBtn = document.getElementById('newProjectBtn');
            
            // Dashboard button is always visible, but behavior changes based on auth
            if (dashboardBtn) {
                dashboardBtn.addEventListener('click', () => {
                    if (currentUser) {
                        // User is authenticated - go to dashboard
                        window.location.href = 'projects.html';
                    } else {
                        // User is NOT authenticated - go to home page
                        window.location.href = 'index.html';
                    }
                });
            }
            
            if (currentUser) {
                // User is authenticated - show New Project
                if (newProjectBtn) newProjectBtn.style.display = 'flex';
            } else {
                // User is NOT authenticated - hide New Project
                if (newProjectBtn) newProjectBtn.style.display = 'none';
            }
            
            // Toggle dropdown
            logoMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                logoDropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!logoMenuBtn.contains(e.target) && !logoDropdown.contains(e.target)) {
                    logoDropdown.classList.remove('active');
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.openSubmitToGalleryModal = async function() {
            // Check if user is logged in
            if (!currentUser) {
                console.log('‚ö†Ô∏è User not logged in, opening login modal');
                openAuthModal();
                return;
            }
            
            const modal = document.getElementById('submitGalleryModal');
            modal.style.display = 'block';
            
            // Load user's projects
            try {
                const { loadProjects } = await import('./js/auth/projects.js');
                const projects = await loadProjects();
                
                const select = document.getElementById('submitProjectSelect');
                select.innerHTML = '<option value="">Choose a project...</option>';
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
                
                // Pre-fill author info
                const fullName = currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || '';
                document.getElementById('submitAuthor').value = fullName;
            } catch (error) {
                console.error('Error loading projects:', error);
                alert('Failed to load your projects. Please try again.');
                closeSubmitGalleryModal();
            }
        };

        window.closeSubmitGalleryModal = function() {
            document.getElementById('submitGalleryModal').style.display = 'none';
            document.getElementById('submitGalleryForm').reset();
            removeThumbnail();
        };

        window.removeThumbnail = function() {
            document.getElementById('thumbnailInput').value = '';
            document.getElementById('thumbnailPreview').style.display = 'none';
            document.getElementById('thumbnailPlaceholder').style.display = 'block';
        };

        // Thumbnail upload handler
        document.getElementById('thumbnailInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('thumbnailImg').src = event.target.result;
                document.getElementById('thumbnailPreview').style.display = 'block';
                document.getElementById('thumbnailPlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        });

        // Character count
        document.getElementById('submitDescription').addEventListener('input', function() {
            document.getElementById('descCharCount').textContent = this.value.length;
        });

        // Form submit
        window.handleSubmitToGallery = async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitGalleryButton');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                const { submitToGallery } = await import('./js/data/github-submit.js');
                
                const projectId = document.getElementById('submitProjectSelect').value;
                const title = document.getElementById('submitTitle').value;
                const description = document.getElementById('submitDescription').value;
                const author = document.getElementById('submitAuthor').value;
                const affiliation = document.getElementById('submitAffiliation').value;
                const thumbnailFile = document.getElementById('thumbnailInput').files[0];
                
                await submitToGallery({
                    projectId,
                    title,
                    description,
                    author,
                    affiliation,
                    thumbnail: thumbnailFile
                });
                
                alert('‚úÖ Your project has been submitted for review!\n\nA merge request has been created on GitHub.');
                closeSubmitGalleryModal();
                
            } catch (error) {
                console.error('Submission error:', error);
                alert('Failed to submit project: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Project';
            }
        };

        window.signOut = async function() {
            await supabase.auth.signOut();
            window.location.reload();
        };
        
        window.createNewProject = function() {
            // Redirect to projects page with new project modal
            window.location.href = 'projects.html?new=true';
        };

        // Handle submit button click - check auth first
        window.handleSubmitClick = function() {
            if (!currentUser) {
                console.log('‚ö†Ô∏è User not logged in, opening login modal');
                openAuthModal();
            } else {
                openSubmitToGalleryModal();
            }
        };

        window.openAuthModal = function() {
            document.getElementById('authModal').classList.add('active');
        };

        window.closeAuthModal = function() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authMessage').innerHTML = '';
        };

        window.toggleAuthMode = function() {
            isSignUp = !isSignUp;
            const title = document.getElementById('authModalTitle');
            const subtitle = document.getElementById('authModalSubtitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleText = document.getElementById('authToggleText');
            const fullNameInput = document.getElementById('authFullName');
            const usernameInput = document.getElementById('authUsername');
            
            if (isSignUp) {
                title.textContent = 'Create your account';
                subtitle.textContent = 'Join Papergraph to save and sync your projects';
                submitBtn.textContent = 'Sign up';
                toggleText.textContent = 'Already have an account?';
                toggleText.nextElementSibling.textContent = 'Sign in';
                fullNameInput.style.display = 'block';
                usernameInput.style.display = 'block';
                fullNameInput.required = true;
                usernameInput.required = true;
            } else {
                title.textContent = 'Welcome to Papergraph';
                subtitle.textContent = 'Sign in to access the gallery features';
                submitBtn.textContent = 'Sign in';
                toggleText.textContent = "Don't have an account?";
                toggleText.nextElementSibling.textContent = 'Sign up';
                fullNameInput.style.display = 'none';
                usernameInput.style.display = 'none';
                fullNameInput.required = false;
                usernameInput.required = false;
            }
        };

        window.handleAuthSubmit = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const messageDiv = document.getElementById('authMessage');
            const submitBtn = document.getElementById('authSubmitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = isSignUp ? 'Creating account...' : 'Signing in...';
            
            try {
                if (isSignUp) {
                    const fullName = document.getElementById('authFullName').value;
                    const username = document.getElementById('authUsername').value;
                    
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: fullName,
                                username: username
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    messageDiv.innerHTML = '<div class="auth-message success">‚úÖ Account created! Check your email to verify.</div>';
                    setTimeout(() => {
                        toggleAuthMode();
                        document.getElementById('authForm').reset();
                    }, 2000);
                } else {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    messageDiv.innerHTML = '<div class="auth-message success">‚úÖ Signed in successfully!</div>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            } catch (error) {
                console.error('Auth error:', error);
                messageDiv.innerHTML = `<div class="auth-message error">‚ùå ${error.message}</div>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isSignUp ? 'Sign up' : 'Sign in';
            }
        };

        window.signInWithGitHub = async function() {
            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: window.location.href
                    }
                });
                
                if (error) throw error;
            } catch (error) {
                console.error('GitHub sign in error:', error);
                document.getElementById('authMessage').innerHTML = `<div class="auth-message error">‚ùå ${error.message}</div>`;
            }
        };

        window.signInWithGoogle = async function() {
            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });
                
                if (error) throw error;
            } catch (error) {
                console.error('Google sign in error:', error);
                document.getElementById('authMessage').innerHTML = `<div class="auth-message error">‚ùå ${error.message}</div>`;
            }
        };

        window.openPreferencesModal = function() {
            const existingModal = document.getElementById('preferencesModal');
            if (!existingModal) {
                fetch('preferences-modal.html')
                    .then(r => r.text())
                    .then(html => {
                        document.body.insertAdjacentHTML('beforeend', html);
                        document.getElementById('preferencesModal').classList.add('active');
                    });
            } else {
                existingModal.classList.add('active');
            }
        };
    </script>
    
    <!-- Load Footer -->
    <script src="js/utils/load-footer.js"></script>
</body>
</html>
